trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  credentials: 'aws-azure'
  region: 'us-east-1'
  helm-alb-uri: 'https://aws.github.io/eks-charts'
  helm-alb-version: '1.4.1'

steps:
  - checkout: self  
  - task: CloudFormationCreateOrUpdateStack@1
    inputs:
      awsCredentials: $(credentials)
      regionName: $(region)
      stackName: 'dev'
      templateSource: 'file'
      templateFile: '$(Build.Repository.LocalPath)/main.yml'
      templateParametersSource: 'inline'
      templateParameters: |
        [
          {
            "ParameterKey":"Project",
            "ParameterValue":"$(Project)"
          },
          {
            "ParameterKey":"Environment",
            "ParameterValue":"$(Environment)"
          },
          {
            "ParameterKey":"MasterUserPassword",
            "ParameterValue":"$(MasterUserPassword)"
          },
          {
            "ParameterKey":"VPCBlock",
            "ParameterValue":"$(VPCBlock)"
          },
          {
            "ParameterKey":"VPCBlockSub1",
            "ParameterValue":"$(VPCBlockSub1)"
          },
          {
            "ParameterKey":"VPCBlockSub2",
            "ParameterValue":"$(VPCBlockSub2)"
          },
          {
            "ParameterKey":"VPCBlockSub3",
            "ParameterValue":"$(VPCBlockSub3)"
          },
          {
            "ParameterKey":"VPCBlockSub4",
            "ParameterValue":"$(VPCBlockSub4)"
          }
        ]

  - task: HelmInstaller@1
    displayName: 'Install Helm'
    inputs:
      helmVersionToInstall: ${{ parameters.helmVersion }}

  - task: AWSShellScript@1
    displayName: 'Pull and deploy Helm Chart'
    inputs:
      awsCredentials: $(credentials)
      regionName: $(region)
      failOnStandardError: true
      scriptType: 'inline'
      inlineScript: |
        # Get Kubeconfig
        echo 'Connect to Amazon EKS cluster'
        aws eks update-kubeconfig --region $(REGION) --name $(PROJECT)-eks-cluster-$(ENVIRONMENT)
                
        # Deploy Helm Chart
        echo 'Deploy Helm chart to EKS...'
        helm install prueba-eks-alb-controller-dev https://aws.github.io/eks-charts/aws-load-balancer-controller \
        --namespace default \
        --version 1.4.1 \
        --set clusterName=$(PROJECT)-eks-cluster-$(ENVIRONMENT) \
        --set image.tag=v2.4.2 \
        --set serviceAccount.name=$(PROJECT)-alb-controller-sa-$(ENVIRONMENT) \
        --set serviceAccount.annotations.eks\\.amazonaws\\.com/role-arn=arn:aws:iam::438555236323:role/$(PROJECT)-alb-controller-rol-$(ENVIRONMENT)



